# 2026-02-12 學習筆記：ADSR 狀態機實作與環境部署自動化

## 1. 專案管理：環境部署文件化
為了確保專案在不同電腦上（如筆電與桌機）能快速還原進度，建立了 `ENVIRONMENT_SETUP.md`。
*   **關鍵工具**：CMake (3.10+), C++ 編譯器 (C++17), Ninja (預設建置系統)。
*   **架構釐清**：確認了由下而上的四層架構 (Level 0 ~ Level 2 + JUCE Integration)。

## 2. DSP 實戰：ADSR Envelope Generator (Level 1)
今天從零開始實作了 `modules/level1_dsp_building_blocks/envelope.h`，這是一個標準的線性 ADSR 包絡產生器。

### 核心架構：有限狀態機 (FSM)
使用 `switch (currentState)` 來管理 `Idle`, `Attack`, `Decay`, `Sustain`, `Release` 五個階段。
*   **事件驅動**：區分「狀態 (State)」與「事件 (Event)」。透過 `noteOn()` 與 `noteOff()` 函式作為外部觸發開關。

### 效能優化：預算步進值 (Pre-calculation)
*   **原則**：避免在 `processSample` 這種高頻率執行的函式中進行**除法運算**。
*   **實作**：引入 `attackDelta` 等變數，在參數改變 (Setter) 或 `prepare()` 時才計算 `1.0f / (time * sampleRate)`。

---

## ⚠️ 高頻易錯點記錄 (Gotchas)

### 1. 名稱遮蔽 (Name Shadowing) 與 `this->`
*   **錯誤**：在函式參數中使用與成員變數相同的名稱（如 `sampleRate`），會導致「近的遮掉遠的」。
*   **解決**：
    *   使用 `this->sampleRate = sampleRate;` 明確指定。
    *   **最佳實踐**：給成員變數加前綴（如 `mSampleRate`）或參數加底線（如 `sampleRate_`）。

### 2. 除以零 (Division by Zero)
*   **風險**：當使用者將 Attack/Decay 時間設為 0 時，計算 Delta 的除法會導致程式崩潰。
*   **解決**：在 `updateDelta` 函式中加入保護邏輯：`if (time < 0.0001f) time = 0.0001f;`。

### 3. 參數聯動失效
*   **錯誤**：漏掉 `setSustain()` 的更新。
*   **原因**：因為 `decayDelta` 和 `releaseDelta` 的公式中都包含 `sustain` 變數。如果改了 Sustain 卻沒重算 Delta，包絡線的坡度會出錯。
*   **解決**：集中管理更新邏輯，讓所有相關 Setter 都呼叫同一個 `updateDelta()`。

### 4. 浮點數型別意識
*   **注意**：在 C++ 中 `1` 是整數，`1.0f` 才是浮點數。雖然編譯器常會自動轉換，但在 DSP 運算中明確寫出 `1.0f` 可以避免不必要的隱含轉型損耗或精度問題。

## 3. 今日進度總結
- [x] 建立全域環境部署清單 `ENVIRONMENT_SETUP.md`
- [x] 建立 C++ 學習路徑 `Learning_Path.md`
- [x] 完成 `envelope.h` 線性 ADSR 模組
- [x] 釐清「平滑器 (Smoother)」與「時間/曲線」的數學關係
